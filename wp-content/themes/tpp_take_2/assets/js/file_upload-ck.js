var dropper=function(){};jQuery(function(e){function t(e,t){alert("Oops, there was an error: "+e+". Please try again")}dropper=function(){dropper.paramname="pic";dropper.maxfiles=1;dropper.maxfilesize=2;dropper.url="";dropper.errors=["BrowserNotSupported","TooManyFiles","FileTooLarge"];dropper.uploading=!1;this.init=function(t){if(e("#upload_destination").length!=1){alert("could not determine your upload destination. File uploads will not work. Please contact us!");return}dropper.url=e("#upload_destination").val();var n=this;t.on({drop:n.drop,dragenter:n.dragEnter,dragover:n.dragOver,dragleave:n.dragLeave},{self:n});e(document).on({drop:n.docDrop,dragenter:n.docEnter,dragover:n.docOver,dragleave:n.docLeave},{self:n});t.on("click",".delete-icon",function(t){var n=confirm("Delete this image?");n===!0&&e(t.delegateTarget).find(".preview").html('<div class="upload-icon"></div>')});t.on("click",".preview",function(t){var n="file_temp_"+e(this).data("ind"),r=document.getElementById(n);if(r===null){r=document.createElement("input");r.setAttribute("type","file");r.setAttribute("id",n);document.body.appendChild(r)}else e(r).unbind("change");e(r).live("change",{evt:t},dropper.selectFiles);r.click()});jQuery("#dropbox").sortable&&jQuery("#dropbox").sortable({placeholder:"ui-state-highlight",stop:function(){dropper.applyOrdering()}})};dropper.selectFiles=function(e){var t=null;e.target.files?t=e.target.files:e.currentTarget.files&&(t=e.currentTarget.files);if(!t){alert("We have detected this functionality is not supported in your browser. Please use Firefox or Google Chrome to access this feature.");return!1}t.length==0||t[0].name==""?dropper.error(dropper.errors[0],e):dropper.upload(e.data.evt,1,t)};this.dragEnter=function(e){e.preventDefault()};this.dragOver=function(e){e.preventDefault();e.data.self.docOver(e)};this.dragLeave=function(e){e.stopPropagation()};this.docDrop=function(e){e.preventDefault();e.data.self.drop(e);return!1};this.docEnter=function(e){e.preventDefault();return!1};this.docOver=function(e){e.preventDefault();return!1};this.docLeave=function(e){};this.drop=function(e){e.preventDefault();files=e.dataTransfer.files;if(files===null||files===undefined){dropper.error(dropper.errors[0],e);return!1}files_count=files.length;dropper.upload(e,files_count,files);return!1};dropper.sendIE=function(e,t){dropper.sendXHRDeprecated(e,t)};dropper.upload=function(t,n,r){if(!r){dropper.error(dropper.errors[0],t);return!1}dropper.files_done=0;dropper.files_rejected=0;if(n>dropper.maxfiles){dropper.error(dropper.errors[1],t);return!1}dropper.files_count=n;dropper.files=r;for(var i=0;i<dropper.files_count;i++)try{if(dropper.beforeEach(dropper.files[i])!=0){if(i===dropper.files_count)return;var s=new FileReader,o=1048576*dropper.maxfilesize;s.index=i;if(r[i].size>dropper.max_file_size){dropper.error(dropper.errors[2],dropper.files[i],i);filesRejected++;return}e(t.currentTarget).hasClass("preview")?e(t.currentTarget).html(""):e(t.currentTarget).find(".preview").remove("");var u=navigator.userAgent.toLowerCase();if(u.indexOf("msie")>-1)dropper.sendIE(r[i],t);else{s.onloadend=function(e){return function(e){dropper.send(e,t)}}(t);s.readAsBinaryString(dropper.files[i])}}else dropper.files_rejected++}catch(a){dropper.error(dropper.errors[0],t);return!1}};dropper.beforeEach=function(e){if(!e.type.match(/^image\//)){overlay.setHeader("Oops");overlay.setBody("Only images (jpg, png, gif) are allowed");overlay.populateInner();return!1}if(e.size>5e5){overlay.setHeader("Oops");overlay.setBody("Your file is a little too big to upload. We recommend uploading a maximum size of 500KB");overlay.populateInner();return!1}};dropper.sendXHR=function(e,t,n){var r=new XMLHttpRequest,i=r.upload,s=t.target.index,o=(new Date).getTime(),u="------multipartformboundary"+(new Date).getTime(),a;newName=e.name;typeof newName=="string"?a=dropper.getBuilder(newName,t.target.result,u):a=dropper.getBuilder(e.name,t.target.result,u);i.index=s;i.file=e;i.downloadStartTime=o;i.currentStart=o;i.currentProgress=0;i.startData=0;i.addEventListener("progress",dropper.progress,!1);dropper.url.substr(-1)!="/"&&(dropper.url+="/");r.open("POST",dropper.url,!0);r.setRequestHeader("content-type","multipart/form-data; boundary="+u);r.sendAsBinary(a);dropper.uploadStarted(s,e,n);r.onload=function(){var t=JSON.parse(r.responseText);if((t&&!t.error||t.error===!1)&&r.responseText)var i=dropper.uploadFinished(n,e,jQuery.parseJSON(r.responseText));else t&&t.error&&t.error===!0&&dropper.uploadFinished(n,e,t)}};dropper.sendXHRDeprecated=function(e,t){var n={};if(window.XMLHttpRequest)n=new XMLHttpRequest;else try{n=new ActiveXObject("MSXML2.XMLHTTP.3.0")}catch(r){alert("Could not complete your request. Please Upgrade your browser - or use Chrome or Firefox, we know these work!");return!1}n.upload.addEventListener("progress",dropper.progress,!1);n.open("POST",dropper.url,!0);n.setRequestHeader("X-FILENAME",e.name);n.send(e);dropper.uploadStarted(0,e,t);n.onload=function(r){var i=JSON.parse(n.responseText);if((i&&!i.error||i.error===!1)&&n.responseText)var s=dropper.uploadFinished(t,e,jQuery.parseJSON(n.responseText));else i&&i.error&&i.error===!0&&dropper.uploadFinished(t,e,i)}};dropper.send=function(e,t){e.target.index==undefined&&(e.target.index=dropper.getIndexBySize(e.total));var n=dropper.files[e.target.index],r=navigator.userAgent.toLowerCase();r.indexOf("safari")!=-1?r.indexOf("chrome")>-1?dropper.sendXHR(n,e,t):dropper.sendXHRDeprecated(n,t):dropper.sendXHR(n,e,t)};dropper.getIndexBySize=function(e){for(var t=0;t<dropper.files_count;t++)if(dropper.files[t].size==e)return t;return undefined};dropper.getBuilder=function(e,t,n){var r="--",i="\r\n",s="";s+=r;s+=n;s+=i;s+='Content-Disposition: form-data; name="'+dropper.paramname+'"';s+='; filename="'+e+'"';s+=i;s+="Content-Type: application/octet-stream";s+=i;s+=i;s+=t;s+=i;s+=r;s+=n;s+=r;s+=i;return s};dropper.progress=function(){dropper.uploading=!0};dropper.uploadStarted=function(t,n,r){dropper.createProgressBar(r);dropper.uploading=!0;e(r.currentTarget).find(".progress").show()};dropper.createProgressBar=function(t){var n='<div class="progressHolder" style="height:100px"><div class="progress" style="display:none"></div></div>',r=e(n);if(e(t.currentTarget).hasClass("preview")){e(t.currentTarget).parent(0).next(".message").slideUp();e(t.currentTarget).html("").append(r)}else{e(t.currentTarget).next(".message").slideUp();if(e(t.currentTarget).find(".preview").length===0){e(t.currentTarget).append('<div class="preview"></div>');r.appendTo(e(t.currentTarget).find(".preview"))}else r.appendTo(e(t.currentTarget))}};dropper.createImage=function(t,n){var r='<span class="imageHolder"><img /><span class="uploaded"></span></span>',i=e(r),s=e("img",i),o=new FileReader;s.width=100;s.height=100;o.onload=function(e){s.attr("src",e.target.result)};o.readAsDataURL(t);e.data(t,i);if(e(n.currentTarget).hasClass("preview")){e(n.currentTarget).parent(0).next(".message").slideUp();e(n.currentTarget).html("").append(i)}else{e(n.currentTarget).next(".message").slideUp();if(e(n.currentTarget).find(".preview").length===0){e(n.currentTarget).append('<div class="preview"></div>');i.appendTo(e(n.currentTarget).find(".preview"))}else i.appendTo(e(n.currentTarget))}};dropper.uploadFinished=function(n,r,i){(!i.error||i.error===!1)&&dropper.createImage(r,n);dropper.uploading=!1;e(n.currentTarget).find(".progress").fadeOut("normal",function(){e(n.currentTarget).find(".progressHolder").remove()});if(i!=undefined&&i.status){var s={};e(n.currentTarget).hasClass("preview")?s=e(n.currentTarget):s=e(n.currentTarget).find(".preview");if(i.error===!0){e(n.currentTarget).append('<div class="upload-icon"></div>');s.append("<div></div>");t(i.status,n)}else if(i.data.saved_name){s.find('input[name="uploaded_pic[]"]').length==1?s.find('input[name="uploaded_pic[]"]').val(i.data.saved_name):s.append('<input type="hidden" name="uploaded_pic[]" value="'+i.data.saved_name+'">');s.find("input.image-ordering").length==1?s.find("input.image-ordering").prop("name","image_ordering["+i.data.saved_name+"]"):s.append('<input type="hidden" class="image-ordering" name="image_ordering['+i.data.saved_name+']" value="0">');dropper.applyOrdering();var o="file_temp_"+s.data("ind"),u=document.getElementById(o);u!==undefined&&e(u).remove()}}},dropper.applyOrdering=function(){e(".photo-box").each(function(t){if(e(this).find("input.image-ordering").length===0)e(this).find(".preview").append('<input type="hidden" class="image-ordering" name="image_ordering[]" value="'+(t+1)+'">');else{e(this).find("input.image-ordering").val(t+1);e(this).find("input.child-image-ordering").val(t+1)}})};dropper.error=function(e,n){switch(e){case"BrowserNotSupported":t("We have detected this functionality is not supported in your browser. Please use Firefox or Google Chrome to access this feature, or upgrade your browser to the latest version.",n);break;case"TooManyFiles":alert("Too many files! Please select 5 at most! (configurable)");break;case"FileTooLarge":alert(file.name+" is too large! Please upload files up to 2mb (configurable).");break;default:alert(e)}}};e(".photo-box").each(function(t){var n=new dropper;e(this).find(".preview").data("ind",t);n.init(e(this))})});